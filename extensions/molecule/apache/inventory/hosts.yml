all:
  children:
    web_server:
      vars:
        php_version: "8.4"
        php_fpm_enabled: true
        php_status_page:
          enabled: true
          status_path: /status-php
          allowed_hosts:
            - 127.0.0.1
            - 172.17.0.1
        apache_php_fpm_integration: true
        apache_php_fpm_version: "{{ php_version }}"
        apache_php_fpm_set_default: true
        apache_php_fpm_proxy_timeout: 300
        apache_php_status_page: "{{ php_status_page }}"
        apache_main_settings:
          - name: LimitRequestLine
            value: 8190
            comment: |
              Maximum size of the request line in bytes.
              Helps prevent buffer overflow attacks.
          - name: LimitRequestFieldSize
            value: 8190
            comment: Maximum size of each HTTP request header field in bytes.
        apache_envvars:
          - name: CUSTOM_LOG_DIR
            value: /var/log/apache2/custom
            comment: Custom log directory for application logs
          - name: DEFAULT_DOMAIN
            value: example.local
            comment: Default domain for the application
        apache_http_ports:
          - 80
          - 8080
        apache_https_ports:
          - 443
          - 8443
        apache_modules_enabled:
          - "rewrite"
          - "headers"
          - "status"
          - "http2"
        apache_security_settings:
          - name: ServerTokens
            value: Prod
          - name: ServerSignature
            value: "Off"
          - name: TraceEnable
            value: "Off"
          - name: FileETag
            value: "None"
          - name: Header always unset X-Powered-By
            value: ""
          - name: Header set X-Content-Type-Options
            value: "nosniff"
        apache_custom_configs:
          - name: Custom security headers
            path: /data/apache-conf/custom-headers.conf
            content: |
              # Custom security headers
              Header always set X-Frame-Options "SAMEORIGIN"
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-XSS-Protection "1; mode=block"
        apache_virtual_hosts:
          - name: secure.example.local
            server_name: secure.example.local
            server_alias:
              - www.secure.example.local
              - www3.secure.example.local
            server_admin: admin@example.local
            document_root: /var/www/secure.example.local
            http:
              listen:
                - "*:80"
                - "*:8080"
              error_log: ${APACHE_LOG_DIR}/secure.example.local-error.log
              custom_log: ${APACHE_LOG_DIR}/secure.example.local-access.log combined
              custom_directives: |
                # Redirect all HTTP to HTTPS
                Redirect permanent / https://secure.example.local/
                <Directory /var/www/secure.example.local>
                    AuthType Basic
                    AuthName "Restricted Content"
                    AuthUserFile /etc/apache2/.htpasswd
                    Require valid-user
                </Directory>
            https:
              listen:
                - "*:443"
                - "*:8443"
              error_log: ${APACHE_LOG_DIR}/secure.example.local-ssl-error.log
              custom_log: ${APACHE_LOG_DIR}/secure.example.local-ssl-access.log combined
              certificate_file: /etc/ssl/certs/ssl-cert-snakeoil.pem
              certificate_key_file: /etc/ssl/private/ssl-cert-snakeoil.key
              custom_directives: |
                # COMMENT TEST
                DirectoryIndex index.html index.php

                <Directory /var/www/secure.example.local>
                    Options -Indexes +FollowSymLinks
                    AllowOverride All
                    # Require all granted
                    AuthType Basic
                    AuthName "Restricted Content"
                    AuthUserFile /etc/apache2/.htpasswd
                    Require valid-user
                </Directory>
        apache_vhost_templates:
          - name: landing_site
            server_name: ${SUBDOMAIN}.${DOMAIN}
            document_root: /var/www/${SUBDOMAIN}
            http:
              error_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.error_log
              custom_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.access_log common
              custom_directives: |
                Include /data/apache-conf/custom-headers.conf
                # Force https
                RewriteEngine on
                RewriteCond %{HTTPS} off
                RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
            https:
              document_root: /var/www/${SUBDOMAIN}/public
              error_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.error_log
              custom_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.access_log common
              certificate_file: /etc/ssl/certs/ssl-cert-snakeoil.pem
              certificate_key_file: /etc/ssl/private/ssl-cert-snakeoil.key
              custom_directives: |
                Include /data/apache-conf/custom-headers.conf
        apache_vhosts_from_template:
          - name: landing1.example.local
            template: landing_site
            vars:
              - name: SUBDOMAIN
                value: landing1
              - name: DOMAIN
                value: ${DEFAULT_DOMAIN}
          - name: landing2.example.local
            template: landing_site
            vars:
              - name: SUBDOMAIN
                value: landing2
              - name: DOMAIN
                value: example.local
        apache_status_page:
          enabled: true
          allowed_hosts:
            - 127.0.0.1
            - 172.17.0.1
        apache_htpasswd_files:
          - path: /etc/apache2/.htpasswd
            users:
              - name: admin
                password: adminpass123
              - name: testuser
                password: testpass456
