all:
  children:
    web_server:
      vars:
        apache_php_fpm_integration: true
        apache_php_fpm_version: "8.3"
        php_packages:
          - "php{{ php_version }}-bcmath"
          - "php{{ php_version }}-curl"
          - "php{{ php_version }}-dev"
          - "php{{ php_version }}-gd"
          - "php{{ php_version }}-imagick"
          - "php{{ php_version }}-imap"
          - "php{{ php_version }}-intl"
          - "php{{ php_version }}-mbstring"
          - "php{{ php_version }}-mysql"
          - "php{{ php_version }}-opcache"
          - "php{{ php_version }}-xml"
          - "php{{ php_version }}-zip"
        apache_php_fpm_set_default: true
        apache_php_fpm_proxy_timeout: 300
        apache_main_settings:
          - name: LimitRequestLine
            value: 8190
            comment: |
              Maximum size of the request line in bytes.
              Helps prevent buffer overflow attacks.
          - name: LimitRequestFieldSize
            value: 8190
            comment: Maximum size of each HTTP request header field in bytes.
        apache_envvars:
          - name: CUSTOM_LOG_DIR
            value: /var/log/apache2/custom
            comment: Custom log directory for application logs
          - name: DEFAULT_DOMAIN
            value: mydomain.local
            comment: Default domain for the application
        apache_http_ports:
          - 80
          - 8080
        apache_https_ports:
          - 443
          - 8443
        apache_modules_enabled:
          - "rewrite"
          - "headers"
          - "status"
          - "http2"
        apache_security_settings:
          - name: ServerTokens
            value: Prod
          - name: ServerSignature
            value: "Off"
          - name: TraceEnable
            value: "Off"
          - name: FileETag
            value: "None"
          - name: Header always unset X-Powered-By
            value: ""
          - name: Header set X-Content-Type-Options
            value: "nosniff"
        apache_custom_configs:
          - name: Custom security headers
            path: /data/apache-conf/custom-headers.conf
            content: |
              # Custom security headers
              Header always set X-Frame-Options "SAMEORIGIN"
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-XSS-Protection "1; mode=block"
        apache_virtual_hosts:
          - name: secure.example.local
            server_name: secure.example.local
            server_alias:
              - www.secure.example.local
              - www3.secure.example.local
            server_admin: admin@example.local
            document_root: /var/www/secure.example.local
            http:
              enabled: true
              listen:
                - "*:80"
                - "*:8080"
              error_log: ${APACHE_LOG_DIR}/secure.example.local-error.log
              access_log: ${APACHE_LOG_DIR}/secure.example.local-access.log combined
              custom_directives: |
                # Redirect all HTTP to HTTPS
                Redirect permanent / https://secure.example.local/
            https:
              listen:
                - "*:443"
                - "*:8443"
              error_log: ${APACHE_LOG_DIR}/secure.example.local-ssl-error.log
              access_log: ${APACHE_LOG_DIR}/secure.example.local-ssl-access.log combined
              certificate_file: /etc/ssl/certs/ssl-cert-snakeoil.pem
              certificate_key_file: /etc/ssl/private/ssl-cert-snakeoil.key
              custom_directives: |
                # COMMENT TEST
                DirectoryIndex index.html index.php

                <Directory /var/www/secure.example.local>
                    Options -Indexes +FollowSymLinks
                    AllowOverride All
                    Require all granted
                </Directory>
        apache_vhost_templates:
          - name: landing_site
            http:
              content: |
                <VirtualHost *:80>
                    ServerName ${SUBDOMAIN}.${DOMAIN}
                    DocumentRoot /var/www/${SUBDOMAIN}
                    ErrorLog ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.error_log
                    CustomLog ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.access_log common
                    Include /data/apache-conf/custom-headers.conf

                    # Force https
                    RewriteEngine on
                    RewriteCond %{HTTPS} off
                    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
                </VirtualHost>
            https:
              content: |
                <VirtualHost *:443>
                    ServerName ${SUBDOMAIN}.${DOMAIN}
                    DocumentRoot /var/www/${SUBDOMAIN}
                    ErrorLog ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.error_log
                    CustomLog ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.access_log common
                    Include /data/apache-conf/custom-headers.conf

                    # SSLCertificateFile /letsencrypt/live/${SUBDOMAIN}.${DOMAIN}/fullchain.pem
                    # SSLCertificateKeyFile /letsencrypt/live/${SUBDOMAIN}.${DOMAIN}/privkey.pem
                    # SSLCertificateChainFile /letsencrypt/live/${SUBDOMAIN}.${DOMAIN}/fullchain.pem
                    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
                    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
                </VirtualHost>
        apache_vhosts_from_template:
          - name: landing1.example.local
            template: landing_site
            vars:
              - name: SUBDOMAIN
                value: landing1
              - name: DOMAIN
                value: ${DEFAULT_DOMAIN}
            http_enabled: true
            https_enabled: true
          - name: landing2.example.local
            template: landing_site
            vars:
              - name: SUBDOMAIN
                value: landing1
              - name: DOMAIN
                value: mydomain.local

        apache_status_page_enabled: true
        apache_htpasswd_files:
          - path: /etc/apache2/.htpasswd
            users:
              - name: admin
                password: adminpass123
              - name: testuser
                password: testpass456
          - path: /etc/apache2/.htpasswd-api
            users:
              - name: api_user
                password: apisecret789

