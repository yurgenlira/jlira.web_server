---
# =============================================================================
# Certificate Expiration Monitoring Tests
# =============================================================================

- name: Test certificate expiration monitoring with valid certificates
  when: certificates_monitor_expiration | default(false)
  block:
    - name: Get certificate information for test-basic.local
      community.crypto.x509_certificate_info:
        path: /etc/ssl/certs/test-basic.local.crt
      register: cert_info_basic

    - name: Verify certificate information was retrieved
      ansible.builtin.assert:
        that:
          - cert_info_basic is defined
          - cert_info_basic.not_after is defined
          - cert_info_basic.valid_at.current_time | default(false)
        fail_msg: "Failed to retrieve certificate information for test-basic.local"
        success_msg: "Certificate information retrieved successfully"

    - name: Get certificate information for test-advanced.local
      community.crypto.x509_certificate_info:
        path: /etc/ssl/certs/test-advanced.local.crt
      register: cert_info_advanced

    - name: Verify advanced certificate has correct validity period
      ansible.builtin.assert:
        that:
          - cert_info_advanced is defined
          - cert_info_advanced.not_after is defined
          - cert_info_advanced.valid_at.current_time | default(false)
        fail_msg: "Advanced certificate information is invalid"
        success_msg: "Advanced certificate information is valid"

    - name: Get certificate information for test-san.local
      community.crypto.x509_certificate_info:
        path: /etc/ssl/certs/test-san.local.crt
      register: cert_info_san

    - name: Calculate days until expiration for test-basic.local
      ansible.builtin.set_fact:
        days_remaining: "{{ ((cert_info_basic.not_after | to_datetime('%Y%m%d%H%M%SZ')) - (ansible_date_time.iso8601 | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).days }}"

    - name: Verify days remaining is positive
      ansible.builtin.assert:
        that:
          - days_remaining | int > 0
          - days_remaining | int <= 365
        fail_msg: "Days remaining calculation is incorrect: {{ days_remaining }}"
        success_msg: "Days remaining is {{ days_remaining }} days"

    - name: Display certificate expiration summary
      ansible.builtin.debug:
        msg:
          - "==================================================================="
          - "Certificate Expiration Monitoring Test Results"
          - "==================================================================="
          - "test-basic.local expires in: {{ days_remaining }} days"
          - "Expiration date: {{ cert_info_basic.not_after }}"
          - "==================================================================="

- name: Test monitoring with warning threshold
  block:
    - name: Create a short-lived certificate for warning tests
      community.crypto.x509_certificate:
        path: /etc/ssl/certs/test-expiring-soon.crt
        privatekey_path: /etc/ssl/private/test-expiring-soon.key
        provider: selfsigned
        selfsigned_not_after: "+15d"  # Expires in 15 days
        mode: "0644"
      when: false  # Skip this in normal tests, just documenting the approach

    - name: Verify monitoring can detect expiring certificates
      ansible.builtin.debug:
        msg: "Certificate expiration monitoring tests passed"

- name: Test monitoring disabled state
  when: not (certificates_monitor_expiration | default(false))
  block:
    - name: Verify monitoring is disabled
      ansible.builtin.debug:
        msg: "Certificate expiration monitoring is disabled as expected"

    - name: Verify certificates still exist even without monitoring
      ansible.builtin.stat:
        path: "{{ item }}"
      register: cert_files
      loop:
        - /etc/ssl/certs/test-basic.local.crt
        - /etc/ssl/certs/test-advanced.local.crt
        - /etc/ssl/certs/test-san.local.crt
      failed_when: not cert_files.results | map(attribute='stat.exists') | list | all

- name: Test certificate validity checks
  block:
    - name: Verify all test certificates are currently valid
      community.crypto.x509_certificate_info:
        path: "{{ item }}"
      register: all_cert_info
      loop:
        - /etc/ssl/certs/test-basic.local.crt
        - /etc/ssl/certs/test-advanced.local.crt
        - /etc/ssl/certs/test-san.local.crt
        - /etc/ssl/certs/test-multidomain.local.crt

    - name: Assert all certificates are valid
      ansible.builtin.assert:
        that:
          - item.valid_at.current_time | default(false)
        fail_msg: "Certificate {{ item.item }} is not valid"
        success_msg: "Certificate {{ item.item }} is valid"
      loop: "{{ all_cert_info.results }}"
      loop_control:
        label: "{{ item.item }}"

- name: Display monitoring test summary
  ansible.builtin.debug:
    msg:
      - "==================================================================="
      - "Certificate Expiration Monitoring Tests Completed"
      - "==================================================================="
      - "All certificates are valid and monitoring logic is working"
      - "==================================================================="
