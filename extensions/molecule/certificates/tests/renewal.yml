---
# =============================================================================
# Automatic Certificate Renewal Tests
# =============================================================================

- name: Test renewal timer setup for Let's Encrypt mode
  when:
    - certificates_mode == 'letsencrypt'
    - certificates_acme_auto_renew | default(false)
  block:
    - name: Check if systemd is available
      ansible.builtin.command: systemctl --version
      register: systemd_check
      changed_when: false
      failed_when: false

    - name: Verify systemd is available
      ansible.builtin.assert:
        that:
          - systemd_check.rc == 0
        fail_msg: "Systemd is not available on this system"
        success_msg: "Systemd is available"

    - name: Check if cert-renew.service file exists
      ansible.builtin.stat:
        path: /etc/systemd/system/cert-renew.service
      register: renewal_service_file

    - name: Verify renewal service file exists
      ansible.builtin.assert:
        that:
          - renewal_service_file.stat.exists
          - renewal_service_file.stat.isreg
          - renewal_service_file.stat.mode == "0644"
          - renewal_service_file.stat.pw_name == "root"
          - renewal_service_file.stat.gr_name == "root"
        fail_msg: "Renewal service file not found or has incorrect permissions"
        success_msg: "Renewal service file exists with correct permissions"

    - name: Read renewal service file content
      ansible.builtin.slurp:
        path: /etc/systemd/system/cert-renew.service
      register: renewal_service_content

    - name: Verify renewal service file contains required sections
      ansible.builtin.assert:
        that:
          - "'[Unit]' in (renewal_service_content.content | b64decode)"
          - "'[Service]' in (renewal_service_content.content | b64decode)"
          - "'[Install]' in (renewal_service_content.content | b64decode)"
          - "'Type=oneshot' in (renewal_service_content.content | b64decode)"
          - "'ExecStart=' in (renewal_service_content.content | b64decode)"
        fail_msg: "Renewal service file missing required sections"
        success_msg: "Renewal service file has all required sections"

    - name: Check if cert-renew.timer file exists
      ansible.builtin.stat:
        path: /etc/systemd/system/cert-renew.timer
      register: renewal_timer_file

    - name: Verify renewal timer file exists
      ansible.builtin.assert:
        that:
          - renewal_timer_file.stat.exists
          - renewal_timer_file.stat.isreg
          - renewal_timer_file.stat.mode == "0644"
          - renewal_timer_file.stat.pw_name == "root"
          - renewal_timer_file.stat.gr_name == "root"
        fail_msg: "Renewal timer file not found or has incorrect permissions"
        success_msg: "Renewal timer file exists with correct permissions"

    - name: Read renewal timer file content
      ansible.builtin.slurp:
        path: /etc/systemd/system/cert-renew.timer
      register: renewal_timer_content

    - name: Verify renewal timer file contains required configuration
      ansible.builtin.assert:
        that:
          - "'[Unit]' in (renewal_timer_content.content | b64decode)"
          - "'[Timer]' in (renewal_timer_content.content | b64decode)"
          - "'[Install]' in (renewal_timer_content.content | b64decode)"
          - "'OnCalendar=' in (renewal_timer_content.content | b64decode)"
          - "'Persistent=true' in (renewal_timer_content.content | b64decode)"
        fail_msg: "Renewal timer file missing required configuration"
        success_msg: "Renewal timer file has all required configuration"

    - name: Check if renewal timer is enabled
      ansible.builtin.systemd:
        name: cert-renew.timer
      register: renewal_timer_status

    - name: Verify renewal timer is enabled
      ansible.builtin.assert:
        that:
          - renewal_timer_status.status.UnitFileState == 'enabled'
        fail_msg: "Renewal timer is not enabled"
        success_msg: "Renewal timer is enabled"
      when: renewal_timer_status.status is defined

    - name: Get renewal timer status
      ansible.builtin.command: systemctl status cert-renew.timer --no-pager
      register: timer_status_output
      changed_when: false
      failed_when: false

    - name: Display renewal timer status
      ansible.builtin.debug:
        msg:
          - "==================================================================="
          - "Renewal Timer Status"
          - "==================================================================="
          - "{{ timer_status_output.stdout_lines }}"
          - "==================================================================="

    - name: Get next scheduled timer activations
      ansible.builtin.command: systemctl list-timers cert-renew.timer --no-pager
      register: timer_list_output
      changed_when: false
      failed_when: false

    - name: Display next scheduled runs
      ansible.builtin.debug:
        msg:
          - "==================================================================="
          - "Next Scheduled Renewal Runs"
          - "==================================================================="
          - "{{ timer_list_output.stdout_lines }}"
          - "==================================================================="

- name: Test renewal disabled scenario
  when:
    - certificates_mode == 'letsencrypt'
    - not (certificates_acme_auto_renew | default(true))
  block:
    - name: Verify renewal timer does not exist when disabled
      ansible.builtin.stat:
        path: /etc/systemd/system/cert-renew.timer
      register: timer_when_disabled

    - name: Assert timer is not present when auto-renewal is disabled
      ansible.builtin.assert:
        that:
          - not timer_when_disabled.stat.exists
        fail_msg: "Renewal timer exists even though auto-renewal is disabled"
        success_msg: "Renewal timer correctly not present when disabled"

- name: Test renewal not applicable for other modes
  when: certificates_mode in ['selfsigned', 'import']
  block:
    - name: Verify renewal timer is not created for non-letsencrypt modes
      ansible.builtin.stat:
        path: /etc/systemd/system/cert-renew.timer
      register: timer_other_modes

    - name: Assert no timer for non-letsencrypt modes
      ansible.builtin.debug:
        msg: "Renewal timer correctly not created for {{ certificates_mode }} mode"
      when: not timer_other_modes.stat.exists

- name: Display renewal tests summary
  ansible.builtin.debug:
    msg:
      - "==================================================================="
      - "Certificate Renewal Tests Completed"
      - "==================================================================="
      - "Mode: {{ certificates_mode }}"
      - "Auto-renewal: {{ certificates_acme_auto_renew | default(false) }}"
      - "All renewal configuration tests passed"
      - "==================================================================="
