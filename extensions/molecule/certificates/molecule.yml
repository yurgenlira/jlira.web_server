---
dependency:
  name: galaxy
  options:
    ignore-certs: false
    ignore-errors: false
    role-file: requirements.yml
    requirements-file: requirements.yml

driver:
  name: docker

platforms:
  # challtestsrv (DNS and HTTP challenge server)
  - name: challtestsrv
    image: ghcr.io/letsencrypt/pebble-challtestsrv:latest
    pre_build_image: true
    published_ports:
      - "8055:8055"  # Management API
    networks:
      - name: molecule-certificates
    command: -http01 "" -https01 "" -tlsalpn01 ""

  # Pebble ACME server (Let's Encrypt test server)
  - name: pebble
    image: ghcr.io/letsencrypt/pebble:latest
    pre_build_image: true
    command: -config /test/config/pebble-config.json -dnsserver challtestsrv:8053
    published_ports:
      - "14000:14000"  # ACME directory
      - "15000:15000"  # Management API
    env:
      PEBBLE_VA_NOSLEEP: "1"
      PEBBLE_VA_ALWAYS_VALID: "1"  # Accept all validations for testing
    networks:
      - name: molecule-certificates
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "https://localhost:15000/dir"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Main test instance
  - name: ${MOLECULE_SCENARIO_NAME}-instance
    image: geerlingguy/docker-ubuntu2404-ansible
    pre_build_image: true
    groups:
      - certificates_test
    # --- Systemd requirements (not needed for certificates but kept for consistency) ---
    privileged: true                  # Required to run systemd/init as PID 1
    command: "/usr/lib/systemd/systemd" # The command to start systemd
    cgroupns_mode: host               # Necessary for cgroups v2 (modern Docker/OS)
    volumes:                          # Mount cgroups filesystem to satisfy systemd
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    networks:
      - name: molecule-certificates
    dns_servers:
      - 8.8.8.8

ansible:
  cfg:
    defaults:
      host_key_checking: false
      verbosity: 1
      roles_path: '$MOLECULE_PROJECT_DIRECTORY/../../roles'
    ssh_connection:
      pipelining: true
  env:
    ANSIBLE_FORCE_COLOR: "1"
    ANSIBLE_LOAD_CALLBACK_PLUGINS: "1"

  executor:
    backend: ansible-playbook
    args:
      ansible_playbook:
        - --diff
        - --force-handlers
        - --inventory=inventory/hosts.yml

  playbooks:
    prepare: prepare.yml
    converge: converge.yml
    verify: verify.yml

scenario:
  name: certificates
  test_sequence:
    - dependency
    - cleanup
    - destroy
    - syntax
    - create
    - prepare
    - converge
    - idempotence
    - verify
    - cleanup
    - destroy
