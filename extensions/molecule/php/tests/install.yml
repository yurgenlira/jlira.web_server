# SPDX-License-Identifier: MIT-0
---
- name: Check PHP version
  ansible.builtin.command: php{{ php_version }} --version
  register: php_version_check
  changed_when: false

- name: Assert PHP is installed
  ansible.builtin.assert:
    that: "php_version in php_version_check.stdout"
    fail_msg: "PHP {{ php_version }} is not installed"

- name: Check PHP extensions
  ansible.builtin.command: php{{ php_version }} -m
  register: php_modules_check
  changed_when: false

- name: Assert core extensions are loaded
  ansible.builtin.assert:
    that:
      - "'bcmath' in php_modules_check.stdout"
      - "'curl' in php_modules_check.stdout"
    fail_msg: "Core PHP extensions are not loaded"

- name: Check if PHP-FPM is installed
  ansible.builtin.command: php-fpm{{ php_version }} --version
  register: phpfpm_version_check
  changed_when: false
  failed_when: false
  when: php_fpm_enabled

- name: Assert PHP-FPM is installed
  ansible.builtin.assert:
    that:
      - phpfpm_version_check.rc == 0
      - "php_version in phpfpm_version_check.stdout"
    fail_msg: "PHP-FPM {{ php_version }} is not installed"
  when: php_fpm_enabled

- name: Check if Composer is installed
  ansible.builtin.command: composer --version
  register: composer_version_check
  changed_when: false
  failed_when: false
  when: php_composer_enabled

- name: Assert Composer is installed
  ansible.builtin.assert:
    that:
      - composer_version_check.rc == 0
      - "'Composer' in composer_version_check.stdout"
    fail_msg: "Composer is not installed"
  when: php_composer_enabled
