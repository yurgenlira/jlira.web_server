---
# Test PHP-FPM status page HTML file (PHP role responsibility)
- name: Check if PHP-FPM status page HTML file exists
  ansible.builtin.stat:
    path: "/var/www/html/fpm-status-{{ php_version }}.html"
  register: fpm_status_html_stat

- name: Assert PHP-FPM status page HTML file exists
  ansible.builtin.assert:
    that:
      - fpm_status_html_stat.stat.exists
      - fpm_status_html_stat.stat.isreg
      - fpm_status_html_stat.stat.pw_name == 'www-data'
      - fpm_status_html_stat.stat.gr_name == 'www-data'
      - fpm_status_html_stat.stat.mode == '0644'
    fail_msg: PHP-FPM status page HTML file does not exist or has incorrect permissions
    success_msg: PHP-FPM status page HTML file exists with correct permissions

- name: Read PHP-FPM status page HTML content
  ansible.builtin.slurp:
    path: "/var/www/html/fpm-status-{{ php_version }}.html"
  register: fpm_status_html_content

- name: Decode PHP-FPM status page HTML content
  ansible.builtin.set_fact:
    fpm_status_html: "{{ fpm_status_html_content.content | b64decode }}"

- name: Assert PHP-FPM status page HTML contains version
  ansible.builtin.assert:
    that:
      - fpm_status_html is search('PHP ' + php_version)
    fail_msg: PHP-FPM status page HTML does not contain PHP version
    success_msg: PHP-FPM status page HTML contains PHP version

- name: Assert PHP-FPM status page HTML contains pool name
  ansible.builtin.assert:
    that:
      - fpm_status_html is search(php_pool_settings.pool_name)
    fail_msg: PHP-FPM status page HTML does not contain pool name
    success_msg: PHP-FPM status page HTML contains pool name

- name: Assert PHP-FPM status page HTML contains status path links
  ansible.builtin.assert:
    that:
      - fpm_status_html is search(php_pool_settings.status_path)
      - fpm_status_html is search(php_pool_settings.status_path + '\\?json')
      - fpm_status_html is search(php_pool_settings.status_path + '\\?html')
      - fpm_status_html is search(php_pool_settings.status_path + '\\?xml')
      - fpm_status_html is search(php_pool_settings.status_path + '\\?full')
    fail_msg: PHP-FPM status page HTML does not contain all status format links
    success_msg: PHP-FPM status page HTML contains all status format links

- name: Assert PHP-FPM status page HTML contains ping path
  ansible.builtin.assert:
    that:
      - fpm_status_html is search(php_pool_settings.ping_path)
    fail_msg: PHP-FPM status page HTML does not contain ping path
    success_msg: PHP-FPM status page HTML contains ping path

# Test Apache proxy configuration (Apache role responsibility - verified via molecule converge)
- name: Check if Apache FPM status configuration file exists
  ansible.builtin.stat:
    path: "/etc/apache2/conf-available/php{{ php_version }}-fpm-status.conf"
  register: apache_fpm_status_conf_stat

- name: Assert Apache FPM status configuration file exists
  ansible.builtin.assert:
    that:
      - apache_fpm_status_conf_stat.stat.exists
      - apache_fpm_status_conf_stat.stat.isreg
    fail_msg: Apache FPM status configuration file does not exist
    success_msg: Apache FPM status configuration file exists

- name: Check if Apache FPM status configuration is enabled
  ansible.builtin.stat:
    path: "/etc/apache2/conf-enabled/php{{ php_version }}-fpm-status.conf"
  register: apache_fpm_status_enabled_stat

- name: Assert Apache FPM status configuration is enabled
  ansible.builtin.assert:
    that:
      - apache_fpm_status_enabled_stat.stat.exists
      - apache_fpm_status_enabled_stat.stat.islnk
    fail_msg: Apache FPM status configuration is not enabled
    success_msg: Apache FPM status configuration is enabled

# Test FPM status endpoints (end-to-end integration test)
- name: Test FPM status endpoint accessibility from localhost
  ansible.builtin.uri:
    url: "http://localhost{{ php_pool_settings.status_path }}"
    return_content: true
    status_code: 200
  register: fpm_status_response
  failed_when: false

- name: Assert FPM status endpoint is accessible
  ansible.builtin.assert:
    that:
      - fpm_status_response.status == 200
      - fpm_status_response.content is search('pool:')
      - fpm_status_response.content is search('process manager:')
    fail_msg: FPM status endpoint is not accessible or does not return expected content
    success_msg: FPM status endpoint is accessible and returns expected content

- name: Test FPM status endpoint JSON format
  ansible.builtin.uri:
    url: "http://localhost{{ php_pool_settings.status_path }}?json"
    return_content: true
    status_code: 200
  register: fpm_status_json_response
  failed_when: false

- name: Assert FPM status JSON endpoint returns valid JSON
  ansible.builtin.assert:
    that:
      - fpm_status_json_response.status == 200
      - fpm_status_json_response.json is defined
      - fpm_status_json_response.json.pool is defined
    fail_msg: FPM status JSON endpoint does not return valid JSON
    success_msg: FPM status JSON endpoint returns valid JSON

- name: Test FPM ping endpoint accessibility from localhost
  ansible.builtin.uri:
    url: "http://localhost{{ php_pool_settings.ping_path }}"
    return_content: true
    status_code: 200
  register: fpm_ping_response
  failed_when: false

- name: Assert FPM ping endpoint is accessible and returns correct response
  ansible.builtin.assert:
    that:
      - fpm_ping_response.status == 200
      - fpm_ping_response.content is search(php_pool_settings.ping_response)
    fail_msg: >-
      FPM ping endpoint is not accessible or does not return expected response
      '{{ php_pool_settings.ping_response }}'
    success_msg: >-
      FPM ping endpoint is accessible and returns
      '{{ php_pool_settings.ping_response }}'

- name: Test FPM status page HTML file accessibility
  ansible.builtin.uri:
    url: "http://localhost/fpm-status-{{ php_version }}.html"
    return_content: true
    status_code: 200
  register: fpm_status_page_response
  failed_when: false

- name: Assert FPM status page HTML is accessible
  ansible.builtin.assert:
    that:
      - fpm_status_page_response.status == 200
      - fpm_status_page_response.content is search('PHP ' + php_version + ' FPM Status Monitor')
    fail_msg: FPM status page HTML is not accessible via web server
    success_msg: FPM status page HTML is accessible via web server