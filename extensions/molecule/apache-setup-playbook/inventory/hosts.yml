all:
  children:
    webservers:
      hosts:
        apache-setup-playbook-instance
      vars:
        ansible_connection: docker
        # ============================================================================
        # START APACHE-SETUP PLAYBOOK CONFIGURATION
        # ============================================================================
        # Web Server Setup Configuration
        certificate_generation: true
        skip_confirm: true

        # ============================================================================
        # START PHP ROLE
        # ============================================================================
        # PHP Version Configuration
        php_version: "8.3"

        # Package Installation
        php_packages:
          - "php{{ php_version }}-cli"
          - "php{{ php_version }}-bcmath"
          - "php{{ php_version }}-curl"
          - "php{{ php_version }}-dev"
          - "php{{ php_version }}-gd"
          - "php{{ php_version }}-imagick"
          - "php{{ php_version }}-imap"
          - "php{{ php_version }}-intl"
          - "php{{ php_version }}-mbstring"
          - "php{{ php_version }}-mysql"
          - "php{{ php_version }}-xml"
          - "php{{ php_version }}-zip"

        # Composer Configuration
        php_composer_enabled: true

        # Version Management
        php_cli_set_as_default_version: true
        php_cli_settings:
          short_open_tag:
            value: true
            type: bool
          memory_limit:
            value: "512M"
            type: string
          error_reporting:
            value: E_ALL & ~E_NOTICE & ~E_STRICT & ~E_DEPRECATED
            type: string
          error_log:
            value: /var/log/php/error.log
            type: path
          post_max_size:
            value: 256M
            type: size
        php_mssql_extension_enabled: true

        # PHP-FPM Configuration
        php_fpm_settings:
          max_execution_time:
            value: 120
            type: int
          memory_limit:
            value: "1024M"
            type: string
          error_reporting:
            value: E_ALL & ~E_NOTICE & ~E_STRICT
            type: string
          error_log:
            value: /var/log/php8.2/php-fpm-error.log
            type: path
        php_fpm_enabled: true
        php_pool_additional_settings:
          slowlog: /var/log/php/php-fpm-slow.log
          php_admin_value[error_log]: /var/log/php/pool-admin-error.log
          php_admin_flag[log_errors]: "on"
        php_pool_settings:
          pool_name: test-pool            # The name of the pool (optional, defaults to www-{version})
          pm: dynamic               # Process manager (static, dynamic, or ondemand)
          pm_max_children: 10        # Maximum number of child processes
          pm_start_servers: 3       # Number of child processes created on startup (dynamic only)
          pm_min_spare_servers: 2   # Minimum number of spare idle processes (dynamic only)
          pm_max_spare_servers: 5   # Maximum number of spare idle processes (dynamic only)

        # PHP-FPM Status Page Configuration
        php_status_page:
          enabled: true
          status_path: /fpm-status
          ping_path: /fpm-ping
          ping_response: healthy

        # Logrotate Configuration
        php_cli_logrotate_enabled: true
        php_fpm_logrotate_enabled: true

        # ============================================================================
        # START APACHE ROLE
        # ============================================================================
        # Basic Configuration
        apache_server_name: "molecule-test"
        apache_ssl_enabled: true

        # PHP-FPM Integration Configuration
        apache_php_fpm_integration: true
        apache_php_fpm_version: "{{ php_version }}"
        apache_php_fpm_set_default: true
        apache_php_fpm_proxy_timeout: 400

        # PHP-FPM Status Page Configuration
        apache_php_status_page:
          enabled: "{{ php_status_page.enabled }}"
          status_path: "{{ php_status_page.status_path }}"
          ping_path: "{{ php_status_page.ping_path }}"
          ping_response: "{{ php_status_page.ping_response }}"
          realtime_endpoint: /realtime-status
          allowed_hosts:
            - 127.0.0.1

        # Apache Main Settings
        apache_main_settings:
          - name: LimitRequestLine
            value: 8190
            comment: |
              Maximum size of the request line in bytes.
              Helps prevent buffer overflow attacks.
          - name: LimitRequestFieldSize
            value: 8190
            comment: Maximum size of each HTTP request header field in bytes.

        # Environment Variables
        apache_envvars:
          - name: CUSTOM_LOG_DIR
            value: /var/log/apache2/custom
            comment: Custom log directory for application logs
          - name: DEFAULT_DOMAIN
            value: example.com
            comment: Default domain for the application

        # Port Configuration
        apache_http_ports:
          - 80
          - 8080
        apache_https_ports:
          - 443
          - 8443

        # Module Management
        apache_modules_enabled:
          - "rewrite"
          - "headers"
          - "status"
          - "http2"

        # Security Configuration
        apache_security_settings:
          - name: ServerTokens
            value: Minor
          - name: ServerSignature
            value: "On"
          - name: Header always unset X-Powered-By
            value: ""
          - name: Header set X-Content-Type-Options
            value: "nosniff"

        # Custom Configuration Files

        apache_custom_configs:
          - name: Custom security headers
            path: /data/apache-conf/custom-headers.conf
            content: |
              # Custom security headers
              Header always set X-Frame-Options "SAMEORIGIN"
              Header always set X-Content-Type-Options "nosniff"
              Header always set X-XSS-Protection "1; mode=block"

        # Virtual Hosts Configuration
        apache_virtual_hosts:
          - name: secure.example.local
            server_name: secure.example.local
            server_alias:
              - www.secure.example.local
              - www3.secure.example.local
            server_admin: admin@example.local
            document_root: /var/www/secure.example.local
            http:
              listen:
                - "*:80"
                - "*:8080"
              error_log: ${APACHE_LOG_DIR}/secure.example.local-error.log
              custom_log: ${APACHE_LOG_DIR}/secure.example.local-access.log combined
              custom_directives: |
                # Redirect all HTTP to HTTPS
                Redirect permanent / https://secure.example.local/
                <Directory /var/www/secure.example.local>
                    AuthType Basic
                    AuthName "Restricted Content"
                    AuthUserFile /etc/apache2/.htpasswd
                    Require valid-user
                </Directory>
            https:
              listen:
                - "*:443"
                - "*:8443"
              error_log: ${APACHE_LOG_DIR}/secure.example.local-ssl-error.log
              custom_log: ${APACHE_LOG_DIR}/secure.example.local-ssl-access.log combined
              certificate_file: /etc/ssl/certs/secure.example.local.crt
              certificate_key_file: /etc/ssl/private/secure.example.local.key
              custom_directives: |
                # COMMENT TEST
                DirectoryIndex index.html index.php

                <Directory /var/www/secure.example.local>
                    Options -Indexes +FollowSymLinks
                    AllowOverride All
                    # Require all granted
                    AuthType Basic
                    AuthName "Restricted Content"
                    AuthUserFile /etc/apache2/.htpasswd
                    Require valid-user
                </Directory>

        # Virtual Host Templates Configuration
        apache_vhost_templates_dir: /etc/apache2/templates
        apache_vhost_templates:
          - name: landing_site
            server_name: ${SUBDOMAIN}.${DOMAIN}
            server_alias:
              - www.${SUBDOMAIN}.${DOMAIN}
            document_root: /var/www/${SUBDOMAIN}
            http:
              error_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.error_log
              custom_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.access_log common
              custom_directives: |
                Include /data/apache-conf/custom-headers.conf
                # Force https
                RewriteEngine on
                RewriteCond %{HTTPS} off
                RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
            https:
              document_root: /var/www/${SUBDOMAIN}/public
              error_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.error_log
              custom_log: ${CUSTOM_LOG_DIR}/${SUBDOMAIN}.${DOMAIN}.access_log common
              certificate_file: /etc/letsencrypt/live/${SUBDOMAIN}.${DOMAIN}/cert.pem
              certificate_key_file: /etc/letsencrypt/live/${SUBDOMAIN}.${DOMAIN}/privkey.pem
              certificate_chain_file: /etc/letsencrypt/live/${SUBDOMAIN}.${DOMAIN}/fullchain.pem
              custom_directives: |
                Include /data/apache-conf/custom-headers.conf
        apache_vhosts_from_template:
          - name: landing1.example.com
            template: landing_site
            vars:
              - name: SUBDOMAIN
                value: landing1
              - name: DOMAIN
                value: ${DEFAULT_DOMAIN}
          - name: landing2.example.com
            template: landing_site
            vars:
              - name: SUBDOMAIN
                value: landing2
              - name: DOMAIN
                value: example.com

        # Status Page Configuration
        apache_status_page:
          enabled: true
          endpoint: /apache-status
          allowed_hosts:
            - 127.0.0.1

        # HTTP Authentication Configuration
        apache_htpasswd_files:
          - path: /etc/apache2/.htpasswd
            users:
              - name: admin
                password: adminpass123
              - name: testuser
                password: testpass456

        # ============================================================================
        # START CERTIFICATES ROLE
        # ============================================================================
        # General Configuration
        certificates_cert_dir: "/etc/ssl/certs"
        certificates_key_dir: "/etc/ssl/private"

        # certificates_items:
        #   - name: "secure.example.local"
        #     mode: "selfsigned"
        #     san:
        #       - "DNS: www.secure.example.local"
        #       - "DNS: www3.secure.example.local"
        #   - name: "landing1.example.com"
        #     mode: "letsencrypt"
        #     webroot: /var/www/landing1
        #     san:
        #       - "www.landing1.example.com"
        #   - name: "landing2.example.com"
        #     webroot: /var/www/landing2
        #     san:
        #       - "www.landing2.example.com"

        # Selfsigned Defaults for Certificates
        certificates_selfsigned_subject:
          country: "MX"
          state: "Jalisco"
          locality: "Guadalajara"
          organization: "JLira"
          organizational_unit: "IT"
          email: "admin@example.local"
        certificates_selfsigned_validity_days: 3650
        # Let's Encrypt (Certbot) Defaults
        certificates_certbot_environment: "test"
        certificates_certbot_email: "{{ certificates_selfsigned_subject.email }}"
        certificates_certbot_server_url: https://pebble:14000/dir
