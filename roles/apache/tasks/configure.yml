# SPDX-License-Identifier: MIT-0
---
- name: Get packages facts
  ansible.builtin.package_facts:
    manager: auto
  no_log: true

- name: Configure apache
  when: "'apache2' in ansible_facts.packages"
  block:
    - name: Configure ServerName and main settings in apache2.conf
      ansible.builtin.blockinfile:
        path: /etc/apache2/apache2.conf
        block: "{{ lookup('template', 'apache2.conf.j2') }}"
        marker: "## {mark} ANSIBLE MANAGED BLOCK - Custom settings ##"
        append_newline: false
        prepend_newline: true
        state: present
      notify: Reload apache

    - name: Configure custom environment variables in envvars
      ansible.builtin.blockinfile:
        path: /etc/apache2/envvars
        block: "{{ lookup('template', 'envvars.j2') }}"
        marker: "## {mark} ANSIBLE MANAGED BLOCK - Custom environment variables ##"
        append_newline: false
        prepend_newline: true
        state: present
      when: apache_envvars | length > 0
      notify: Reload apache

    - name: Configure ports in ports.conf
      ansible.builtin.template:
        src: ports.conf.j2
        dest: /etc/apache2/ports.conf
        owner: root
        group: root
        mode: "0644"
      notify: Reload apache

    - name: Enable SSL module
      ansible.builtin.command:
        cmd: a2enmod ssl
      register: apache_enable_ssl_module_result
      changed_when: "'Enabling module' in apache_enable_ssl_module_result.stdout"
      when: apache_ssl_enabled
      notify: Reload apache

    - name: Enable Apache modules
      ansible.builtin.command:
        cmd: "a2enmod {{ item }}"
      register: apache_enable_module_result
      changed_when: "'Enabling module' in apache_enable_module_result.stdout"
      loop: "{{ apache_modules_enabled }}"
      notify: Reload apache

    - name: Configure default HTTP virtual host
      ansible.builtin.template:
        src: 000-default.conf.j2
        dest: /etc/apache2/sites-available/000-default.conf
        owner: root
        group: root
        mode: "0644"
      notify: Reload apache

    - name: Rename default SSL virtual host configuration
      ansible.builtin.command:
        cmd: rm /etc/apache2/sites-available/default-ssl.conf
      args:
        removes: /etc/apache2/sites-available/default-ssl.conf
      notify: Reload apache

    - name: Check if default SSL certificate file exists
      ansible.builtin.stat:
        path: "{{ apache_default_ssl_certificate_file }}"
      register: apache_default_ssl_cert_stat
      when: apache_ssl_enabled

    - name: Check if default SSL certificate key file exists
      ansible.builtin.stat:
        path: "{{ apache_default_ssl_certificate_key_file }}"
      register: apache_default_ssl_key_stat
      when: apache_ssl_enabled

    - name: Set fact for SSL certificate status
      ansible.builtin.set_fact:
        apache_ssl_certificates_exist: >-
          {{ apache_default_ssl_cert_stat.stat.exists | default(false) and
             apache_default_ssl_key_stat.stat.exists | default(false) }}
      when: apache_ssl_enabled

    - name: Handle missing SSL certificates - Fail
      ansible.builtin.fail:
        msg: |
          SSL is enabled but certificate files are missing:
          - Certificate: {{ apache_default_ssl_certificate_file }}
            (exists: {{ apache_default_ssl_cert_stat.stat.exists | default(false) }})
          - Key: {{ apache_default_ssl_certificate_key_file }}
            (exists: {{ apache_default_ssl_key_stat.stat.exists | default(false) }})

          Options to fix:
          1. Set apache_ssl_certificate_fallback: 'disable' to skip SSL
          2. Set apache_ssl_certificate_fallback: 'generate' to auto-generate self-signed certs
          3. Provide valid certificate paths via apache_default_ssl_certificate_* variables
          4. Generate certificates using jlira.web_server.certificates role
      when:
        - apache_ssl_enabled
        - not apache_ssl_certificates_exist
        - apache_ssl_certificate_fallback == 'fail'

    - name: Handle missing SSL certificates - Generate self-signed
      when:
        - apache_ssl_enabled
        - not apache_ssl_certificates_exist
        - apache_ssl_certificate_fallback == 'generate'
      block:
        - name: Install OpenSSL for certificate generation
          ansible.builtin.apt:
            name: openssl
            state: present
            update_cache: true

        - name: Create directory for default SSL certificate
          ansible.builtin.file:
            path: "{{ apache_default_ssl_certificate_key_file | dirname }}"
            state: directory
            mode: '0700'
            owner: root
            group: root

        - name: Generate self-signed SSL certificate
          ansible.builtin.command:
            cmd: >
              openssl req -x509 -nodes -days {{ apache_ssl_selfsigned_days }}
              -newkey rsa:4096
              -keyout {{ apache_default_ssl_certificate_key_file }}
              -out {{ apache_default_ssl_certificate_file }}
              -subj "/CN={{ inventory_hostname }}/O={{ apache_ssl_selfsigned_organization }}"
            creates: "{{ apache_default_ssl_certificate_file }}"

        - name: Set certificate file permissions
          ansible.builtin.file:
            path: "{{ apache_default_ssl_certificate_file }}"
            mode: '0644'
            owner: root
            group: root

        - name: Set key file permissions
          ansible.builtin.file:
            path: "{{ apache_default_ssl_certificate_key_file }}"
            mode: '0640'
            owner: root
            group: root

        - name: Update certificate status fact
          ansible.builtin.set_fact:
            apache_ssl_certificates_exist: true

    - name: Display warning for disabled SSL
      ansible.builtin.debug:
        msg: |
          WARNING: SSL was requested but certificates are missing.
          SSL configuration will be skipped. Apache will run HTTP-only.
          Certificate: {{ apache_default_ssl_certificate_file }} (missing)
          Key: {{ apache_default_ssl_certificate_key_file }} (missing)
      when:
        - apache_ssl_enabled
        - not apache_ssl_certificates_exist
        - apache_ssl_certificate_fallback == 'disable'

    - name: Configure default SSL virtual host
      ansible.builtin.template:
        src: 000-default-ssl.conf.j2
        dest: /etc/apache2/sites-available/000-default-ssl.conf
        owner: root
        group: root
        mode: "0644"
      when:
        - apache_ssl_enabled
        - apache_ssl_certificates_exist | default(false)
      notify: Reload apache

    - name: Enable default SSL site
      ansible.builtin.command:
        cmd: a2ensite 000-default-ssl
      args:
        creates: /etc/apache2/sites-enabled/000-default-ssl.conf
      register: apache_enable_ssl_result
      changed_when: "'Enabling site' in apache_enable_ssl_result.stdout"
      when:
        - apache_ssl_enabled
        - apache_ssl_certificates_exist | default(false)
      notify: Reload apache

    - name: Configure Apache security settings
      ansible.builtin.lineinfile:
        path: /etc/apache2/conf-available/security.conf
        regexp: '^{{ item.name }}'
        line: '{{ item.name }} {{ item.value }}'
        state: present
      loop: "{{ apache_security_settings }}"
      notify: Reload apache
      when: not ansible_check_mode

    - name: Enable security configuration
      ansible.builtin.command:
        cmd: a2enconf security
      args:
        creates: /etc/apache2/conf-enabled/security.conf
      notify: Reload apache

# - name: Flush handlers
#   ansible.builtin.meta: flush_handlers
