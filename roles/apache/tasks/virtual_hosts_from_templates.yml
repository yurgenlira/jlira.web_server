# SPDX-License-Identifier: MIT-0
---
- name: Create apache virtualhost from template folders
  ansible.builtin.file:
    path: "{{ apache_vhost_templates_dir }}"
    state: directory
    mode: '0755'

- name: Create HTTP virtual host templates
  ansible.builtin.template:
    src: vhost_template.j2
    dest: "{{ apache_vhost_templates_dir }}/{{ item.name }}.template.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ apache_vhost_templates }}"
  when:
    - apache_vhost_templates | length > 0
    - item.http is defined
  notify: Reload apache

- name: Create HTTPS virtual host templates
  ansible.builtin.template:
    src: vhost-ssl_template.j2
    dest: "{{ apache_vhost_templates_dir }}/{{ item.name }}-ssl.template.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ apache_vhost_templates }}"
  when:
    - apache_vhost_templates | length > 0
    - item.https is defined
  notify: Reload apache

# =============================================================================
# Virtual Host SSL Certificate Management (Template-based)
# =============================================================================

- name: Extract SSL certificate paths from template definitions
  ansible.builtin.set_fact:
    apache_vhost_template_ssl_paths: >-
      {{
        apache_vhost_template_ssl_paths | default({}) | combine({
          item.name: {
            'certificate_file': (item.https.content
              | default('')
              | regex_findall('(?:^|\n)(?!\s*#)\s*SSLCertificateFile\s+(\S+)')
              | first
              | default('')
            ),
            'certificate_key_file': (item.https.content
              | default('')
              | regex_findall('(?:^|\n)(?!\s*#)\s*SSLCertificateKeyFile\s+(\S+)')
              | first
              | default('')
            ),
            'server_name': (item.https.content
              | default('')
              | regex_findall('(?:^|\n)(?!\s*#)\s*ServerName\s+(\S+)')
              | first
              | default('')
            ),
            'server_alias': (item.https.content
              | default('')
              | regex_findall('(?:^|\n)(?!\s*#)\s*ServerAlias\s+(.+)')
              | first
              | default('')
              | split()
            )
          }
        })
      }}
  loop: "{{ apache_vhost_templates | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - apache_vhost_templates | length > 0
    - item.https is defined
    - item.https.content is defined

- name: Build certificate paths for virtual host instances
  ansible.builtin.set_fact:
    apache_vhost_template_cert_paths: >-
      {{
        apache_vhost_template_cert_paths | default([]) +
        [{
          'name': item.name,
          'template': item.template,
          'vars': item.vars | default([]),
          'certificate_file': apache_vhost_template_ssl_paths[item.template].certificate_file,
          'certificate_key_file': apache_vhost_template_ssl_paths[item.template].certificate_key_file,
          'server_name_template': apache_vhost_template_ssl_paths[item.template].server_name,
          'server_alias_template': apache_vhost_template_ssl_paths[item.template].server_alias
        }]
      }}
  loop: "{{ apache_vhosts_from_template | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - apache_vhosts_from_template | length > 0
    - item.https_enabled | default(true)
    - apache_vhost_template_ssl_paths is defined
    - item.template in apache_vhost_template_ssl_paths

- name: Expand variables in SSL certificate paths
  ansible.builtin.shell: |
    set -o pipefail
    source /etc/apache2/envvars
    {% for envvar in apache_envvars | default([]) %}
    export {{ envvar.name }}="{{ envvar.value }}"
    {% endfor %}
    {% for var in item.vars | default([]) %}
    export {{ var.name }}="{{ var.value | replace('${', '$') | replace('}', '') }}"
    {% endfor %}

    cert_path="{{ item.certificate_file }}"
    key_path="{{ item.certificate_key_file }}"
    server_name="{{ item.server_name_template }}"
    server_alias="{{ item.server_alias_template | join(' ') }}"

    expanded_cert=$(echo "$cert_path" | envsubst)
    expanded_key=$(echo "$key_path" | envsubst)
    expanded_server_name=$(echo "$server_name" | envsubst)
    expanded_server_alias=$(echo "$server_alias" | envsubst)

    echo "CERT:$expanded_cert"
    echo "KEY:$expanded_key"
    echo "SERVERNAME:$expanded_server_name"
    echo "SERVERALIAS:$expanded_server_alias"
  args:
    executable: /bin/bash
  loop: "{{ apache_vhost_template_cert_paths | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  register: apache_vhost_template_expanded_paths
  changed_when: false
  when:
    - apache_vhost_template_cert_paths | default([]) | length > 0

- name: Build final certificate path list with expanded variables
  ansible.builtin.set_fact:
    apache_vhost_template_final_certs: >-
      {{
        apache_vhost_template_final_certs | default([]) +
        [{
          'name': item.item.name,
          'certificate_file': (item.stdout_lines | select('match', '^CERT:') | first | regex_replace('^CERT:', '')),
          'certificate_key_file': (item.stdout_lines | select('match', '^KEY:') | first | regex_replace('^KEY:', '')),
          'server_name': (item.stdout_lines | select('match', '^SERVERNAME:') | first | regex_replace('^SERVERNAME:', '')),
          'server_alias': (item.stdout_lines | select('match', '^SERVERALIAS:') | first | regex_replace('^SERVERALIAS:', '') | split())
        }]
      }}
  loop: "{{ apache_vhost_template_expanded_paths.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - apache_vhost_template_expanded_paths.results | default([]) | length > 0

- name: Include common SSL certificate management tasks
  ansible.builtin.include_tasks: ssl_certificate_management.yml
  vars:
    apache_ssl_cert_list: "{{ apache_vhost_template_final_certs | default([]) }}"
    apache_ssl_vhost_type: "template-based"
    apache_ssl_skip_list_var: "apache_vhost_template_https_skip"
  when: apache_vhost_template_final_certs | default([]) | length > 0

# =============================================================================
# HTTPS Virtual Host Configuration (Template-based)
# =============================================================================

- name: Create HTTP virtual host configuration files from template
  ansible.builtin.template:
    src: vhost_from_template.conf.j2
    dest: "/etc/apache2/sites-available/{{ item.name }}.conf"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ apache_vhosts_from_template }}"
  when:
    - apache_vhosts_from_template | length > 0
  notify: Reload apache

- name: Create HTTPS virtual host configuration files from template
  ansible.builtin.template:
    src: vhost-ssl_from_template.conf.j2
    dest: "/etc/apache2/sites-available/{{ item.name }}-ssl.conf"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ apache_vhosts_from_template }}"
  when:
    - apache_vhosts_from_template | length > 0
  notify: Reload apache

- name: Create directories for template-based virtual hosts
  ansible.builtin.shell: |
    set -o pipefail
    source /etc/apache2/envvars
    {% for envvar in apache_envvars | default([]) %}
    export {{ envvar.name }}="{{ envvar.value }}"
    {% endfor %}
    {% for var in item.vars | default([]) %}
    export {{ var.name }}="{{ var.value | replace('${', '$') | replace('}', '') }}"
    {% endfor %}

    # Function to extract and create directories from a config file
    process_config() {
      local config_file="$1"

      if [ ! -f "$config_file" ]; then
        return
      fi

      # Find template file if config contains Include directive
      template_file=$(grep -E '^\s*Include' "$config_file" | \
                      awk '{print $2}' | head -1)

      if [ -n "$template_file" ] && [ -f "$template_file" ]; then
        # Read from the template file
        config_to_process="$template_file"
      else
        # Read from the config file itself
        config_to_process="$config_file"
      fi

      # Extract and create DocumentRoot directories
      grep -E '^\s*DocumentRoot' "$config_to_process" | \
        awk '{print $2}' | while read -r docroot; do
        expanded_path=$(echo "$docroot" | envsubst)
        mkdir -p "$expanded_path"
        echo "$expanded_path"
      done || true

      # Extract and create ErrorLog directories
      grep -E '^\s*ErrorLog' "$config_to_process" | \
        awk '{print $2}' | while read -r logpath; do
        expanded_path=$(echo "$logpath" | envsubst)
        logdir=$(dirname "$expanded_path")
        mkdir -p "$logdir"
        echo "$logdir"
      done || true

      # Extract and create CustomLog directories
      grep -E '^\s*CustomLog' "$config_to_process" | \
        awk '{print $2}' | while read -r logpath; do
        expanded_path=$(echo "$logpath" | envsubst)
        logdir=$(dirname "$expanded_path")
        mkdir -p "$logdir"
        echo "$logdir"
      done || true
    }

    # Process both HTTP and HTTPS configs
    process_config "/etc/apache2/sites-available/{{ item.name }}.conf"
    process_config "/etc/apache2/sites-available/{{ item.name }}-ssl.conf"
  args:
    executable: /bin/bash
  loop: "{{ apache_vhosts_from_template }}"
  when:
    - apache_vhosts_from_template | length > 0
  changed_when: false

- name: Enable HTTP virtual hosts from template
  ansible.builtin.command:
    cmd: "a2ensite {{ item.name }}"
  args:
    creates: /etc/apache2/sites-enabled/{{ item.name }}.conf
  register: apache_enable_template_http_vhost_result
  changed_when: "'Enabling site' in apache_enable_template_http_vhost_result.stdout"
  loop: "{{ apache_vhosts_from_template }}"
  when:
    - apache_vhosts_from_template | length > 0
    - item.http_enabled | default(true)
  notify: Reload apache

- name: Disable HTTP virtual hosts from template
  ansible.builtin.command:
    cmd: "a2dissite {{ item.name }}"
  args:
    removes: /etc/apache2/sites-enabled/{{ item.name }}.conf
  register: apache_disable_template_http_vhost_result
  changed_when:
    - "'Site' in apache_disable_template_vhost_result.stdout"
    - "'disabled' in apache_disable_template_vhost_result.stdout"
  loop: "{{ apache_vhosts_from_template }}"
  when:
    - apache_vhosts_from_template | length > 0
    - not (item.http_enabled | default(true))
  notify: Reload apache

- name: Enable HTTPS virtual hosts from template
  ansible.builtin.command:
    cmd: "a2ensite {{ item.name }}-ssl"
  args:
    creates: /etc/apache2/sites-enabled/{{ item.name }}-ssl.conf
  register: apache_enable_template_https_vhost_result
  changed_when: "'Enabling site' in apache_enable_template_https_vhost_result.stdout"
  loop: "{{ apache_vhosts_from_template }}"
  when:
    - apache_vhosts_from_template | length > 0
    - item.https_enabled | default(true)
    - item.name not in apache_vhost_template_https_skip | default([])
  notify: Reload apache

- name: Disable HTTPS virtual hosts from template
  ansible.builtin.command:
    cmd: "a2dissite {{ item.name }}-ssl"
  args:
    removes: /etc/apache2/sites-enabled/{{ item.name }}-ssl.conf
  register: apache_disable_template_https_vhost_result
  changed_when:
    - "'Site' in apache_disable_template_https_vhost_result.stdout"
    - "'disabled' in apache_disable_template_https_vhost_result.stdout"
  loop: "{{ apache_vhosts_from_template }}"
  when:
    - apache_vhosts_from_template | length > 0
    - not (item.https_enabled | default(true))
  notify: Reload apache
