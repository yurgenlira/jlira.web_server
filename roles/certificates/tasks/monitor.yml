# SPDX-License-Identifier: MIT-0
---
# =============================================================================
# Certificate Expiration Monitoring
# =============================================================================

- name: Get certificate information
  community.crypto.x509_certificate_info:
    path: "{{ certificates_cert_dir }}/{{ item.name }}.crt"
  register: certificates_info
  loop: "{{ certificates_list }}"
  loop_control:
    label: "{{ item.name }}"
  failed_when: false

- name: Calculate days until expiration
  ansible.builtin.set_fact:
    certificates_expiration_status: >-
      {{
        certificates_expiration_status | default([]) +
        [{
          'name': item.item.name,
          'not_after': item.not_after,
          'days_remaining': ((item.not_after | to_datetime('%Y%m%d%H%M%SZ')) - (ansible_date_time.iso8601 | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).days,
          'is_valid': item.valid_at.current_time | default(false),
          'expired': ((item.not_after | to_datetime('%Y%m%d%H%M%SZ')) - (ansible_date_time.iso8601 | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).days < 0
        }]
      }}
  loop: "{{ certificates_info.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - item.not_after is defined
    - not item.failed

- name: Display certificate expiration status
  ansible.builtin.debug:
    msg:
      - "========================================================================="
      - "Certificate Expiration Status for {{ item.name }}"
      - "========================================================================="
      - "Expiration date: {{ item.not_after }}"
      - "Days remaining: {{ item.days_remaining }}"
      - "Status: {{ 'EXPIRED' if item.expired else ('WARNING' if item.days_remaining < certificates_expiration_warning_days else 'OK') }}"
      - "========================================================================="
  loop: "{{ certificates_expiration_status | default([]) }}"
  loop_control:
    label: "{{ item.name }}"

- name: Log warnings for certificates expiring soon
  ansible.builtin.debug:
    msg:
      - "WARNING: Certificate '{{ item.name }}' will expire in {{ item.days_remaining }} days"
      - "Expiration date: {{ item.not_after }}"
  loop: "{{ certificates_expiration_status | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - not item.expired
    - item.days_remaining < certificates_expiration_warning_days
    - certificates_expiration_action == 'log'

- name: Fail if certificates are critically close to expiring
  ansible.builtin.fail:
    msg: >-
      CRITICAL: Certificate '{{ item.name }}' will expire in {{ item.days_remaining }} days!
      Expiration date: {{ item.not_after }}
      Please renew the certificate immediately.
  loop: "{{ certificates_expiration_status | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - not item.expired
    - item.days_remaining < certificates_expiration_critical_days
    - certificates_expiration_action == 'fail'

- name: Fail if certificates have expired
  ansible.builtin.fail:
    msg: >-
      CRITICAL: Certificate '{{ item.name }}' has EXPIRED!
      Expiration date: {{ item.not_after }}
      The certificate must be renewed immediately.
  loop: "{{ certificates_expiration_status | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - item.expired
    - certificates_expiration_action in ['fail', 'log']

- name: Display monitoring summary
  ansible.builtin.debug:
    msg:
      - "========================================================================="
      - "Certificate Expiration Monitoring Summary"
      - "========================================================================="
      - "Total certificates monitored: {{ certificates_expiration_status | default([]) | length }}"
      - "Expired: {{ certificates_expiration_status | default([]) | selectattr('expired', 'equalto', true) | list | length }}"
      - "Expiring soon (< {{ certificates_expiration_warning_days }} days): {{ certificates_expiration_status | default([]) | rejectattr('expired') | selectattr('days_remaining', 'lt', certificates_expiration_warning_days) | list | length }}"
      - "Critical (< {{ certificates_expiration_critical_days }} days): {{ certificates_expiration_status | default([]) | rejectattr('expired') | selectattr('days_remaining', 'lt', certificates_expiration_critical_days) | list | length }}"
      - "========================================================================="
