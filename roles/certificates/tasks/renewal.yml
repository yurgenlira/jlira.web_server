# SPDX-License-Identifier: MIT-0
---
# =============================================================================
# Automatic Certificate Renewal Setup
# =============================================================================

- name: Check if systemd is available
  ansible.builtin.command: systemctl --version
  register: certificates_systemd_check
  changed_when: false
  failed_when: false

- name: Setup automatic renewal with systemd timer
  when:
    - certificates_acme_auto_renew | bool
    - certificates_systemd_check.rc == 0
    - certificates_mode == 'letsencrypt'
  block:
    - name: Create systemd service file for certificate renewal
      ansible.builtin.template:
        src: cert-renew.service.j2
        dest: /etc/systemd/system/cert-renew.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd

    - name: Create systemd timer file for certificate renewal
      ansible.builtin.template:
        src: cert-renew.timer.j2
        dest: /etc/systemd/system/cert-renew.timer
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd

    - name: Force systemd reload if files changed
      ansible.builtin.meta: flush_handlers

    - name: Enable and start certificate renewal timer
      ansible.builtin.systemd:
        name: cert-renew.timer
        enabled: true
        state: started
        daemon_reload: true

    - name: Display renewal timer status
      ansible.builtin.command: systemctl status cert-renew.timer --no-pager
      register: certificates_timer_status
      changed_when: false
      failed_when: false

    - name: Display timer information
      ansible.builtin.debug:
        msg:
          - "========================================================================="
          - "Certificate Automatic Renewal Configured"
          - "========================================================================="
          - "Timer: cert-renew.timer"
          - "Service: cert-renew.service"
          - "Schedule: Twice daily (00:00 and 12:00)"
          - "Renewal threshold: {{ certificates_acme_renew_days_before_expiry }} days before expiry"
          - "Status: {{ 'active' if 'active' in certificates_timer_status.stdout else 'inactive' }}"
          - "========================================================================="
          - "Next scheduled runs:"
          - "{{ certificates_timer_status.stdout_lines | select('search', 'Trigger:') | list }}"
          - "========================================================================="

- name: Warning if systemd not available
  ansible.builtin.debug:
    msg:
      - "WARNING: Systemd is not available on this system."
      - "Automatic certificate renewal will not be configured."
      - "You must configure manual renewal using cron or another scheduler."
  when:
    - certificates_acme_auto_renew | bool
    - certificates_systemd_check.rc != 0
