---
- name: Validate certificate configuration
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.mode | default('auto') in ['auto', 'selfsigned', 'letsencrypt', 'imported']
    fail_msg: "Invalid configuration for certificate {{ item.name | default('undefined') }}"
  loop: "{{ certificates_items }}"
  loop_control:
    label: "{{ item.name | default('undefined') }}"

- name: Validate imported certificate requirements
  ansible.builtin.assert:
    that:
      - item.src_cert is defined
      - item.src_key is defined
    fail_msg: "Imported certificate {{ item.name }} requires src_cert and src_key"
  loop: "{{ certificates_items }}"
  when: item.mode | default('auto') == 'imported'
  loop_control:
    label: "{{ item.name }}"

- name: Validate DNS provider configuration (DNS-01 with plugin)
  ansible.builtin.assert:
    that:
      - item.dns_provider is defined or certificates_certbot_defaults.dns_provider != ''
      - item.dns_credentials is defined or certificates_certbot_defaults.dns_credentials != ''
    fail_msg: >-
      DNS-01 challenge for {{ item.name }} requires 'dns_provider' and 'dns_credentials' (or defaults).
  loop: "{{ certificates_items }}"
  when:
    - >-
      item.mode | default('auto') == 'letsencrypt' or
      (item.name.split('.')[-1] not in ['test', 'example', 'local', 'invalid', 'localhost']
      and item.mode is not defined)
    - item.challenge_type | default('http-01') == 'dns-01'
    - (item.dns_provider | default(certificates_certbot_defaults.dns_provider)) != 'custom'
  loop_control:
    label: "{{ item.name }}"

- name: Validate DNS custom hooks configuration (DNS-01 with custom)
  ansible.builtin.assert:
    that:
      - item.auth_hook is defined or certificates_certbot_defaults.auth_hook != ''
      - item.cleanup_hook is defined or certificates_certbot_defaults.cleanup_hook != ''
    fail_msg: >-
      DNS-01 challenge with custom provider for {{ item.name }} requires 'auth_hook' and 'cleanup_hook'.
  loop: "{{ certificates_items }}"
  when:
    - >-
      item.mode | default('auto') == 'letsencrypt' or
      (item.name.split('.')[-1] not in ['test', 'example', 'local', 'invalid', 'localhost']
      and item.mode is not defined)
    - item.challenge_type | default('http-01') == 'dns-01'
    - (item.dns_provider | default(certificates_certbot_defaults.dns_provider)) == 'custom'
  loop_control:
    label: "{{ item.name }}"
