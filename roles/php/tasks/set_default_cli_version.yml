# SPDX-License-Identifier: MIT-0
---
- name: Verify PHP binary exists
  ansible.builtin.stat:
    path: "/usr/bin/php{{ php_version }}"
  register: php_binary_check
  failed_when: not php_binary_check.stat.exists
  when: not ansible_check_mode

- name: Check current default PHP CLI version
  ansible.builtin.command: php --version
  register: php_current_version
  changed_when: false
  failed_when: false

- name: Check if PHP CLI php.ini exists
  ansible.builtin.stat:
    path: "/etc/php/{{ php_version }}/cli/php.ini"
  register: php_cli_ini_stat

- name: Check if PHP development package is installed
  ansible.builtin.command: dpkg-query -W -f='${Status}' php{{ php_version }}-dev
  register: php_dev_check
  changed_when: false
  failed_when: false
  tags:
    - install_mssql_extension
    - php_install_mssql_extension

- name: Set PHP CLI tools as default for version {{ php_version }}
  community.general.alternatives:
    name: "{{ item }}"
    path: "/usr/bin/{{ item }}{{ php_version }}"
    state: selected
  loop:
    - php
    - phar
    - phar.phar
  when:
    - php_cli_set_as_default_version
    - php_current_version.stdout is not defined or php_version not in php_current_version.stdout
    - php_cli_ini_stat.stat.exists

- name: Set PHP development tools as default for version {{ php_version }}
  community.general.alternatives:
    name: "{{ item }}"
    path: "/usr/bin/{{ item }}{{ php_version }}"
    state: selected
  loop:
    - phpize
    - php-config
  when:
    - php_cli_set_as_default_version
    - php_current_version.stdout is not defined or php_version not in php_current_version.stdout
    - php_cli_ini_stat.stat.exists
    - php_dev_check.rc == 0
    - "'install ok installed' in php_dev_check.stdout"
  tags:
    - install_mssql_extension
    - php_install_mssql_extension
