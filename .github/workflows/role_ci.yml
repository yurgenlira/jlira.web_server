name: CI - Generic Role

# This makes the workflow reusable
on:
  workflow_call:
    inputs:
      role-name:
        required: true
        type: string

env:
  PYTHON_VERSION: '3.12'
  UBUNTU_VERSION: 'ubuntu-24.04'
  WORKING_DIR: 'jlira/web_server'

jobs:
  lint:
    name: Lint code for ${{ inputs.role-name }} role
    runs-on: ${{ env.UBUNTU_VERSION }}

    steps:
      - name: Check out the codebase.
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.WORKING_DIR }}/extensions/requirements-lint.txt

      - run: echo '${{ steps.cp312.outputs.cache-hit }}' # true if cache-hit occurred on the primary key

      - name: Install lint dependencies.
        run: pip install -r ${{ env.WORKING_DIR }}/extensions/requirements-lint.txt

      - name: Run ansible lint
        run: ansible-lint ${{ env.WORKING_DIR }}/roles/${{ inputs.role-name }} ${{ env.WORKING_DIR }}/extensions/molecule/${{ inputs.role-name }}


  test:
    name: Run molecule tests for ${{ inputs.role-name }} role
    runs-on: ${{ env.UBUNTU_VERSION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ env.WORKING_DIR }}/extensions/requirements-test.txt

      - name: Install molecule test dependencies
        run: pip install -r ${{ env.WORKING_DIR }}/extensions/requirements.txt

      # The 'extensions' directory contains Ansible roles for Molecule testing.
      - name: Run molecule test for ${{ inputs.role-name }} role
        working-directory: ${{ env.WORKING_DIR }}/extensions
        run: molecule test -s ${{ inputs.role-name }}
